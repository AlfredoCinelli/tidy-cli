# Continuous Delivery Workflow

# Name of the Pipeline
name: CD-PIPELINE

# Name of each CD run (with commit sha)
run-name: "ğŸš€ Deploy to PyPI and Release | ${{ github.sha }}"

# Trigger event
on:
  push: # event type (push on main is allowed only upon PR merging, due to branch protection rulset)
    branches:
    - main

# Jobs definition
jobs:
  # Build package and publish first (fail fast approach with atomic deployment)
  package-build-and-publish:
    runs-on: ubuntu-latest
    name: Package Building and Publishing

    steps:
    # Checkout code to download repository into the Runner
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Install uv via pinned version
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.14"

    # Install Python via Project toml version
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version-file: "pyproject.toml"
    
      # Install Project dependencies with dev group
    - name: ğŸ“¦ Install the Dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        uv sync --group dev
        echo "âœ… Dependencies installed"

    # Run build with dist check
    - name: ğŸ”¨ Build Package Distribution
      run: |
        echo "ğŸ”¨ Building package distribution..."
        bash scripts/build.sh
        echo "âœ… Package built successfully"

    - name: ğŸš€ Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ Publishing to PyPI..."
        uv run twine upload dist/*
        echo "âœ… Successfully published to PyPI"

  # Deploy documentation to GitHub Pages
  deploy-docs:
    runs-on: ubuntu-latest
    name: Deploy MKdocs
    needs: package-build-and-publish
    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.14"

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version-file: "pyproject.toml"

    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        uv sync --group dev
        echo "âœ… Dependencies installed"

    - name: ğŸ“š Deploy Documentation
      run: |
        echo "ğŸ“š Deploying documentation..."
        uv run mkdocs gh-deploy
        echo "âœ… Documentation deployed successfully"

  # Create GitHub release with tag based on CHANGELOG latest content
  create-release:
    runs-on: ubuntu-latest
    name: Create Git Tag and GitHub Release
    needs: [package-build-and-publish, deploy-docs]
    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“‹ Extract Version and Release Notes
      id: extract
      run: |
        echo "ğŸ“‹ Extracting version and release notes..."
        # Extract latest version from CHANGELOG.md
        VERSION=$(grep -m 1 "^## \[" CHANGELOG.md | sed 's/^## \[\(.*\)\] - .*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Extract release notes for the latest version
        awk '/^## \[/{if(p) exit; p=1; next} p && /^## \[/{exit} p' CHANGELOG.md > release_notes.md
        
        echo "ğŸ“‹ Release notes for version $VERSION:"
        cat release_notes.md
        echo "âœ… Version and release notes extracted"

    - name: ğŸ·ï¸ Create Git Tag
      run: |
        echo "ğŸ·ï¸ Creating git tag..."
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ steps.extract.outputs.version }}" -m "Release v${{ steps.extract.outputs.version }}"
        git push origin "v${{ steps.extract.outputs.version }}"
        echo "âœ… Git tag v${{ steps.extract.outputs.version }} created"

    - name: ğŸ‰ Create and Publish GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ steps.extract.outputs.version }}"
        name: "v${{ steps.extract.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false